<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Three.js Bone Demo</title>
<style>
body {
  background: #333;
}
.view{
  display: block;
  margin: 0 auto;
  background: #000;
}
</style>
</head>
<body>
<canvas class="view" id="view" width="640" height="480"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r83/three.js"></script>
<script>

var lastTime = 0;
function tick(time) {
  var elapsedTime = time - lastTime;
  arm.rotation.y += elapsedTime * .0002;
  armMixer.update(elapsedTime);
  skeletonHelper.update()
  renderer.render(scene, camera);
  requestAnimationFrame(tick);
  lastTime = time;
}

var renderer = new THREE.WebGLRenderer({
  canvas: view,
});
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(
  60, 640 / 480, 1, 100
);
camera.position.set(0, 20, -40);
camera.lookAt(new THREE.Vector3(0, 5, 0));

var armGeometry = new THREE.CylinderGeometry(5, 5, 40, 3, 4, true);
armGeometry.bones = [
  {
    name: "bone0",
    parent: -1,
    pos: [0, -20, 0],
    rotq: [0, 0, 0, 1],
    scl: [1, 1, 1],
  },
  {
    name: "bone1",
    parent: 0,
    pos: [0, 10, 0],
    rotq: [0, 0, 0, 1],
    scl: [1, 1, 1],
  },
  {
    name: "bone2",
    parent: 1,
    pos: [0, 10, 0],
    rotq: [0, 0, 0, 1],
    scl: [1, 1, 1],
  },
  {
    name: "bone3",
    parent: 2,
    pos: [0, 10, 0],
    rotq: [0, 0, 0, 1],
    scl: [1, 1, 1],
  },
  {
    name: "bone4",
    parent: 3,
    pos: [0, 10, 0],
    rotq: [0, 0, 0, 1],
    scl: [1, 1, 1],
  },
];

armGeometry.skinIndices = [
  new THREE.Vector4(4, 3, -1, -1), new THREE.Vector4(4, 3, -1, -1), new THREE.Vector4(4, 3, -1, -1),
  new THREE.Vector4(3, 4,  2, -1), new THREE.Vector4(3, 4,  2, -1), new THREE.Vector4(3, 4,  2, -1),
  new THREE.Vector4(2, 3,  1, -1), new THREE.Vector4(2, 3,  1, -1), new THREE.Vector4(2, 3,  1, -1),
  new THREE.Vector4(1, 2,  0, -1), new THREE.Vector4(1, 2,  0, -1), new THREE.Vector4(1, 2,  0, -1),
  new THREE.Vector4(0, 1, -1, -1), new THREE.Vector4(0, 1, -1, -1), new THREE.Vector4(0, 1, -1, -1),
];

armGeometry.skinWeights = [
  new THREE.Vector4(.8, .2,  0, 0), new THREE.Vector4(.8, .2,  0, 0), new THREE.Vector4(.8, .2,  0, 0),
  new THREE.Vector4(.6, .2, .2, 0), new THREE.Vector4(.6, .2, .2, 0), new THREE.Vector4(.6, .2, .2, 0),
  new THREE.Vector4(.6, .2, .2, 0), new THREE.Vector4(.6, .2, .2, 0), new THREE.Vector4(.6, .2, .2, 0),
  new THREE.Vector4(.6, .2, .2, 0), new THREE.Vector4(.6, .2, .2, 0), new THREE.Vector4(.6, .2, .2, 0),
  new THREE.Vector4(.8, .2,  0, 0), new THREE.Vector4(.8, .2,  0, 0), new THREE.Vector4(.8, .2,  0, 0),
];

var armMaterial = new THREE.MeshNormalMaterial({
  skinning: true,
  side: THREE.DoubleSide,
  shading: THREE.FlatShading,
});

var arm = new THREE.SkinnedMesh(armGeometry, armMaterial);
var armMixer = new THREE.AnimationMixer(arm);

var waveClip = THREE.AnimationClip.parseAnimation({
  hierarchy: [
    {},
    {},
    {
      keys: [
        {
          pos: [0, 10, 0],
          rot: new THREE.Quaternion().setFromEuler(new THREE.Euler(- Math.PI / 4, 0, 0)),
          scl: [1, 1, 1],
          time: 0,
        },
        {
          pos: [0, 10, 0],
          rot: new THREE.Quaternion().setFromEuler(new THREE.Euler(Math.PI / 4, 0, 0)),
          scl: [1, 1, 1],
          time: 1000,
        },
        {
          pos: [0, 10, 0],
          rot: new THREE.Quaternion().setFromEuler(new THREE.Euler(- Math.PI / 4, 0, 0)),
          scl: [1, 1, 1],
          time: 2000,
        },
      ],
    },
    {},
    {},
  ]
}, armGeometry.bones);

var twistClip = THREE.AnimationClip.parseAnimation({
  hierarchy: [
    {},
    {},
    {
      keys: [
        {
          pos: [0, 10, 0],
          rot: new THREE.Quaternion().setFromEuler(new THREE.Euler(0, - Math.PI / 2, 0)),
          scl: [1, 1, 1],
          time: 0,
        },
        {
          pos: [0, 10, 0],
          rot: new THREE.Quaternion().setFromEuler(new THREE.Euler(0, Math.PI / 2, 0)),
          scl: [1, 1, 1],
          time: 1000,
        },
        {
          pos: [0, 10, 0],
          rot: new THREE.Quaternion().setFromEuler(new THREE.Euler(0, - Math.PI / 2, 0)),
          scl: [1, 1, 1],
          time: 2000,
        },
      ],
    },
    {},
    {},
  ]
}, armGeometry.bones);

var waveAction = armMixer.clipAction(waveClip);
var twistAction = armMixer.clipAction(twistClip);

var clipSwitchFlag = true;
window.addEventListener("click", function() {
  if(clipSwitchFlag) {
    waveAction.crossFadeFrom(twistAction, 1000);
    waveAction.play();
    waveAction.enabled = true;
  } else {
    twistAction.crossFadeFrom(waveAction, 1000);
    twistAction.play();
    twistAction.enabled = true;
  }
  clipSwitchFlag = !clipSwitchFlag;
})

var skeletonHelper = new THREE.SkeletonHelper(arm);
scene.add(arm);
scene.add(skeletonHelper);

requestAnimationFrame(tick);
</script>
</body>
</html>
